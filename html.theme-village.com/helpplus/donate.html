<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Donation Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- intl-tel-input CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.min.css"
  />

  <style>
    /* Custom styles */
    .progress { height: 1.5rem; border-radius: .75rem; overflow: hidden; }
    .progress-bar { line-height: 1.5rem; font-weight: 600; }
    .donation-title { font-weight: 700; font-size: 1.5rem; }
    .donation-progress-text { font-size: 1rem; color: #495057; }
    .input-group-text { background-color: #ffc107; color: #fff; font-weight: 600; }
    .preset-buttons .btn { flex: 1; }
    .preset-buttons .btn-outline-dark { background: #fff; border: 1px solid #212529; color: #212529; }
    .preset-buttons .btn-warning { border: 1px solid #ffc107; color: #212529; }
    .btn-donate { border-radius: 50px; }

    /* Ensure country dropdown overlays the funding-amount controls */
    .iti__country-list {
      position: absolute !important;
      z-index: 2000        !important;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="donation-title mb-2">Supporting Pregnant and Parenting Youth</h2>
            <p class="donation-progress-text mb-3">$1.11 million of $10,000 raised</p>
            <div class="progress mb-4">
              <div class="progress-bar bg-warning text-white" role="progressbar" style="width: 11.1%;">11.1%</div>
            </div>

            <form id="donationForm" class="needs-validation" novalidate>
              <!-- Name -->
              <div class="mb-3">
                <label for="donorName" class="form-label">Name<span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="donorName" name="donorName" required>
                <div class="invalid-feedback">Please enter your name.</div>
              </div>

              <!-- Email + Phone -->
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="donorEmail" class="form-label">Email<span class="text-danger">*</span></label>
                  <input type="email" class="form-control" id="donorEmail" name="donorEmail" placeholder="you@example.com" required>
                  <div class="invalid-feedback">Please enter a valid email.</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="donorPhone" class="form-label">Phone<span class="text-danger">*</span></label>
                  <input type="tel" class="form-control" id="donorPhone" name="donorPhone" required>
                  <div class="invalid-feedback">Please enter a valid phone number.</div>
                </div>
              </div>

              <!-- Funding Amount -->
              <div class="mb-3">
                <label for="fundingAmount" class="form-label">Funding Amount<span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" id="fundingAmount" name="fundingAmount" min="1" required>
                  <div class="invalid-feedback">Please enter an amount.</div>
                </div>
              </div>

              <!-- Preset Buttons -->
              <div class="mb-3 preset-buttons d-flex">
                <button type="button" class="btn btn-outline-dark mx-1" data-amount="10">$10</button>
                <button type="button" class="btn btn-outline-dark mx-1" data-amount="50">$50</button>
                <button type="button" class="btn btn-outline-dark mx-1" data-amount="100">$100</button>
                <button type="button" class="btn btn-outline-dark mx-1" data-amount="300">$300</button>
                <button type="button" class="btn btn-warning mx-1 active" data-amount="custom">Custom</button>
              </div>

              <!-- Card Details -->
              <div class="mb-3">
                <label for="cardNumber" class="form-label">Card Number<span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  id="cardNumber"
                  name="cardNumber"
                  placeholder="1234567812345678"
                  pattern="\d{16}"
                  maxlength="16"
                  minlength="16"
                  inputmode="numeric"
                  required
                >
                <div class="invalid-feedback">Please enter a 16-digit card number.</div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="expDate" class="form-label">Expiration Date<span class="text-danger">*</span></label>
                  <input
                    type="text"
                    class="form-control"
                    id="expDate"
                    name="expDate"
                    placeholder="MM/YY"
                    pattern="(0[1-9]|1[0-2])\/\d{2}"
                    maxlength="5"
                    required
                  >
                  <div class="invalid-feedback">Enter a valid MM/YY date.</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="cvv" class="form-label">CVV<span class="text-danger">*</span></label>
                  <input
                    type="text"
                    class="form-control"
                    id="cvv"
                    name="cvv"
                    placeholder="123"
                    pattern="\d{3}"
                    maxlength="3"
                    minlength="3"
                    inputmode="numeric"
                    required
                  >
                  <div class="invalid-feedback">Enter a 3-digit CVV.</div>
                </div>
              </div>

              <div class="text-center mt-4">
                <button type="submit" class="btn btn-warning btn-lg btn-donate px-5">Donate Now</button>
              </div>
            </form>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- intl-tel-input JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>

  <script>
    // Initialize intl-tel-input with Jordan default
    const phoneInput = document.querySelector("#donorPhone");
    const iti = window.intlTelInput(phoneInput, {
      initialCountry: "jo",
      utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
    });

    // Preset amount buttons
    document.querySelectorAll(".preset-buttons .btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".preset-buttons .btn").forEach(b =>
          b.classList.replace("btn-warning", "btn-outline-dark")
        );
        btn.classList.replace("btn-outline-dark", "btn-warning");
        const amt = btn.dataset.amount;
        const amtInput = document.getElementById("fundingAmount");
        if (amt === "custom") {
          amtInput.value = "";
          amtInput.focus();
        } else {
          amtInput.value = amt;
        }
      });
    });

    // Form validation and AJAX submit
    (function() {
      "use strict";
      const form = document.getElementById("donationForm");
      form.addEventListener("submit", function(e) {
        e.preventDefault();
        if (!form.checkValidity()) {
          form.classList.add("was-validated");
          return;
        }
        // Get full international phone number (E.164)
        const fullPhone = iti.getNumber();

        const payload = {
          donorName: form.donorName.value,
          donorEmail: form.donorEmail.value,
          donorPhone: fullPhone,
          fundingAmount: form.fundingAmount.value,
          cardNumber: form.cardNumber.value,
          expDate: form.expDate.value,
          cvv: form.cvv.value
        };

        fetch("/api/donations", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(res => res.ok ? res.json() : Promise.reject("Network error"))
        .then(() => window.location.href = "thankyou.html")
        .catch(err => {
          console.error("Submission failed:", err);
          alert("There was a problem processing your donation.");
        });
      });
    })();
  </script>
</body>
</html>
